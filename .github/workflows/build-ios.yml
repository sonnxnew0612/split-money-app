ame: Build iOS IPA (Unsigned)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 18
        
    - name: Install Dependencies
      run: |
        rm -rf package-lock.json node_modules
        npm install
    
    # --- B∆Ø·ªöC 1: S·ª¨A L·ªñI BUILD (QUAN TR·ªåNG) ---
    - name: Fix @capacitor-firebase/authentication Package.swift
      run: |
        cd node_modules/@capacitor-firebase/authentication
        M_FILE=$(ls ios/Plugin/*.m | xargs basename)
        cat <<EOF > Package.swift
        // swift-tools-version: 5.9
        import PackageDescription
        let package = Package(
            name: "CapacitorFirebaseAuthentication",
            platforms: [.iOS(.v13)],
            products: [
                .library(
                    name: "CapacitorFirebaseAuthentication",
                    targets: ["CapacitorFirebaseAuthentication"])
            ],
            dependencies: [
                .package(url: "https://github.com/ionic-team/capacitor-swift-pm.git", from: "6.0.0"),
                .package(url: "https://github.com/firebase/firebase-ios-sdk.git", from: "10.0.0")
            ],
            targets: [
                .target(
                    name: "CapacitorFirebaseAuthentication",
                    dependencies: [
                        .product(name: "Capacitor", package: "capacitor-swift-pm"),
                        .product(name: "Cordova", package: "capacitor-swift-pm"),
                        .product(name: "FirebaseAuth", package: "firebase-ios-sdk")
                    ],
                    path: "ios/Plugin",
                    exclude: ["$M_FILE"]
                )
            ]
        )
        EOF
      
    - name: Build React App
      run: npm run build
      
    - name: Sync Capacitor
      run: npx cap sync ios

    # --- B∆Ø·ªöC 2: T·ª∞ ƒê·ªòNG S·ª¨A L·ªñI ƒêƒÇNG NH·∫¨P GMAIL ---
    # B∆∞·ªõc n√†y s·∫Ω l·∫•y m√£ t·ª´ GoogleService-Info.plist v√† th√™m v√†o Info.plist
    # ƒë·ªÉ Google bi·∫øt ƒë∆∞·ªùng quay l·∫°i app sau khi ƒëƒÉng nh·∫≠p.
    - name: Configure Info.plist for Google Sign-In
      run: |
        gem install xcodeproj
        gem install plist
        
        ruby -e '
          require "xcodeproj"
          require "plist"
          
          # ƒê∆Ø·ªúNG D·∫™N FILE (D·ª±a tr√™n c·∫•u tr√∫c folder b·∫°n ƒë√£ g·ª≠i)
          project_path = "ios/App/App.xcodeproj"
          # File n√†y ch·ª©a th√¥ng tin b√≠ m·∫≠t c·ªßa Firebase
          google_plist_path = "ios/App/App/GoogleService-Info.plist" 
          # File n√†y ch·ª©a c·∫•u h√¨nh c·ªßa App
          info_plist_path = "ios/App/App/Info.plist"
          
          # A. ƒê·∫¢M B·∫¢O FILE GOOGLE ƒê√É ƒê∆Ø·ª¢C TH√äM V√ÄO D·ª∞ √ÅN
          project = Xcodeproj::Project.open(project_path)
          group = project.main_group["App"]
          unless group.files.find { |f| f.path == "GoogleService-Info.plist" }
            file_ref = group.new_file("GoogleService-Info.plist")
            target = project.targets.first
            target.add_resources([file_ref])
            project.save
            puts "‚úÖ ƒê√£ th√™m GoogleService-Info.plist v√†o Xcode Project"
          end
          # B. L·∫§Y M√É REVERSED_CLIENT_ID V√Ä C·∫§U H√åNH URL SCHEME
          if File.exist?(google_plist_path)
            google_data = Plist::parse_xml(google_plist_path)
            reversed_client_id = google_data["REVERSED_CLIENT_ID"]
            
            if reversed_client_id
                puts "üîë T√¨m th·∫•y m√£: #{reversed_client_id}"
                
                info_data = Plist::parse_xml(info_plist_path)
                info_data["CFBundleURLTypes"] ||= []
                
                # Ki·ªÉm tra xem ƒë√£ c√≥ m√£ n√†y ch∆∞a, ch∆∞a c√≥ th√¨ th√™m v√†o
                unless info_data["CFBundleURLTypes"].any? { |t| t["CFBundleURLSchemes"]&.include?(reversed_client_id) }
                  info_data["CFBundleURLTypes"] << {
                    "CFBundleURLSchemes" => [reversed_client_id],
                    "CFBundleTypeRole" => "Editor"
                  }
                  File.open(info_plist_path, "w") { |f| f.write(info_data.to_plist) }
                  puts "‚úÖ ƒê√£ s·ª≠a xong l·ªói ƒëƒÉng nh·∫≠p! (Added URL Scheme)"
                else
                  puts "‚ÑπÔ∏è App ƒë√£ ƒë∆∞·ª£c c·∫•u h√¨nh ƒë√∫ng t·ª´ tr∆∞·ªõc."
                end
            else
                puts "‚ùå C·∫¢NH B√ÅO: Kh√¥ng t√¨m th·∫•y REVERSED_CLIENT_ID trong file GoogleService!"
            end
          else
            puts "‚ùå L·ªñI: B·∫°n ch∆∞a upload file GoogleService-Info.plist v√†o th∆∞ m·ª•c ios/App/App/"
            exit 1
          end
        '
      
    - name: Build Archive (xcodebuild)
      run: |
        cd ios/App
        xcodebuild -project App.xcodeproj -scheme App -configuration Release -derivedDataPath build -destination 'generic/platform=iOS' CODE_SIGNING_ALLOWED=NO clean build
        
    - name: Create IPA manually
      run: |
        mkdir -p Payload
        cp -r ios/App/build/Build/Products/Release-iphoneos/App.app Payload/
        zip -r SplitMoney.ipa Payload
        
    - name: Upload Artifact (IPA)
      uses: actions/upload-artifact@v4
      with:
        name: SplitMoney-iOS
        path: SplitMoney.ipa
